# Firewalld - zapora sieciowa w RHEL/AlmaLinux

## Wprowadzenie do firewalld

Firewalld to dynamiczna zapora sieciowa zarządzana przez daemon, która obsługuje strefy sieciowe definiujące poziom zaufania do połączeń sieciowych. Jest to domyślne rozwiązanie firewall w systemach RHEL/AlmaLinux, zastępujące starsze podejście z iptables.

**Kluczowe cechy firewalld:**
- Dynamiczne zarządzanie regułami bez restartowania
- Koncepcja stref sieciowych (zones)
- Wsparcie dla IPv4 i IPv6
- Integracja z NetworkManager
- Rich rules dla zaawansowanych konfiguracji

## Podstawowe polecenia firewalld

### Sprawdzanie stanu firewalld

```bash
# Sprawdź status firewalld
sudo systemctl status firewalld

# Sprawdź czy firewalld jest aktywny
sudo firewall-cmd --state

# Uruchom firewalld
sudo systemctl start firewalld

# Włącz autostart firewalld
sudo systemctl enable firewalld
```

### Zarządzanie strefami

```bash
# Wyświetl wszystkie dostępne strefy
sudo firewall-cmd --get-zones

# Sprawdź aktywne strefy
sudo firewall-cmd --get-active-zones

# Sprawdź domyślną strefę
sudo firewall-cmd --get-default-zone

# Ustaw domyślną strefę
sudo firewall-cmd --set-default-zone=home

# Wyświetl konfigurację konkretnej strefy
sudo firewall-cmd --zone=public --list-all

# Wyświetl wszystkie konfiguracje
sudo firewall-cmd --list-all-zones
```

### Zarządzanie interfejsami sieciowymi

```bash
# Przypisz interfejs do strefy (tymczasowo)
sudo firewall-cmd --zone=home --change-interface=enp0s3

# Przypisz interfejs do strefy (trwale)
sudo firewall-cmd --permanent --zone=home --change-interface=enp0s3
sudo firewall-cmd --reload

# Sprawdź do jakiej strefy należy interfejs
sudo firewall-cmd --get-zone-of-interface=enp0s3
```

## Zarządzanie usługami

### Dostępne usługi

```bash
# Wyświetl wszystkie dostępne usługi
sudo firewall-cmd --get-services

# Sprawdź aktywne usługi w domyślnej strefie
sudo firewall-cmd --list-services

# Sprawdź aktywne usługi w konkretnej strefie
sudo firewall-cmd --zone=public --list-services
```

### Dodawanie i usuwanie usług

```bash
# Dodaj usługę tymczasowo (do restartu)
sudo firewall-cmd --add-service=http

# Dodaj usługę trwale
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --reload

# Usuń usługę tymczasowo
sudo firewall-cmd --remove-service=http

# Usuń usługę trwale
sudo firewall-cmd --permanent --remove-service=http
sudo firewall-cmd --reload

# Sprawdź czy usługa jest dostępna w strefie
sudo firewall-cmd --query-service=ssh
```

### Zarządzanie portami

```bash
# Dodaj port tymczasowo
sudo firewall-cmd --add-port=8080/tcp

# Dodaj port trwale
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload

# Dodaj zakres portów
sudo firewall-cmd --permanent --add-port=5000-5010/tcp
sudo firewall-cmd --reload

# Usuń port
sudo firewall-cmd --permanent --remove-port=8080/tcp
sudo firewall-cmd --reload

# Wyświetl otwarte porty
sudo firewall-cmd --list-ports

# Sprawdź czy port jest otwarty
sudo firewall-cmd --query-port=22/tcp
```

## Przykłady praktyczne

### Konfiguracja serwera web

```bash
# Dodaj usługi HTTP i HTTPS
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# Lub dodaj porty bezpośrednio
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp

# Zastosuj zmiany
sudo firewall-cmd --reload

# Sprawdź konfigurację
sudo firewall-cmd --list-all
```

### Konfiguracja dla różnych interfejsów

```bash
# Interfejs zewnętrzny (public zone) - ograniczony dostęp
sudo firewall-cmd --permanent --zone=public --change-interface=enp0s3
sudo firewall-cmd --permanent --zone=public --add-service=ssh
sudo firewall-cmd --permanent --zone=public --add-service=http

# Interfejs wewnętrzny (trusted zone) - pełny dostęp
sudo firewall-cmd --permanent --zone=trusted --change-interface=enp0s8

sudo firewall-cmd --reload
```

### Rich Rules - zaawansowane reguły

```bash
# Zablokuj konkretny adres IP
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='192.168.1.100' reject"

# Zezwól na SSH tylko z konkretnej sieci
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='192.168.1.0/24' service name='ssh' accept"

# Ograniczenie liczby połączeń
sudo firewall-cmd --permanent --add-rich-rule="rule service name='ssh' accept limit value='3/m'"

# Przekierowanie portów
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' forward-port port='8080' protocol='tcp' to-port='80'"

sudo firewall-cmd --reload
```

## Strefy firewalld

| Strefa | Poziom zaufania | Zastosowanie |
|:------:|:---------------:|:-------------|
| **drop** | Najniższy | Odrzuca wszystkie pakiety, tylko wychodzące są dozwolone |
| **block** | Bardzo niski | Odrzuca pakiety z odpowiedzią icmp-host-prohibited |
| **public** | Niski | Dla użytku publicznego, nie ufamy innym komputerom |
| **external** | Niski | Dla interfejsów zewnętrznych z maskowaniem NAT |
| **dmz** | Średni | Strefa zdemilitaryzowana, ograniczony dostęp |
| **work** | Średni-wysoki | Dla środowiska pracy, ufamy większości komputerów |
| **home** | Wysoki | Dla użytku domowego, ufamy większości komputerów |
| **internal** | Wysoki | Dla sieci wewnętrznej, ufamy większości komputerów |
| **trusted** | Najwyższy | Wszystkie połączenia są akceptowane |

## Najlepsze praktyki

### Bezpieczna konfiguracja

```bash
# 1. Rozpocznij od restrykcyjnej konfiguracji
sudo firewall-cmd --set-default-zone=public

# 2. Dodawaj tylko niezbędne usługi
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http

# 3. Używaj konkretnych portów zamiast usług gdy to możliwe
sudo firewall-cmd --permanent --add-port=2222/tcp  # SSH na niestandardowym porcie

# 4. Regularnie sprawdzaj konfigurację
sudo firewall-cmd --list-all

# 5. Testuj zmiany przed ich utrwaleniem
sudo firewall-cmd --add-service=ftp  # test tymczasowy
# Jeśli działa prawidłowo, dodaj na stałe:
sudo firewall-cmd --permanent --add-service=ftp
sudo firewall-cmd --reload
```

### Kopie zapasowe konfiguracji

```bash
# Backup konfiguracji firewalld
sudo cp -r /etc/firewalld /etc/firewalld.backup.$(date +%Y%m%d)

# Lub eksport do pliku
sudo firewall-cmd --list-all > firewalld-config.txt
```

## Rozwiązywanie problemów

### Diagnostyka

```bash
# Sprawdź status i błędy
sudo systemctl status firewalld
sudo journalctl -u firewalld -f

# Sprawdź aktualną konfigurację iptables (backend)
sudo iptables -L -n
sudo ip6tables -L -n

# Debug mode
sudo firewall-cmd --debug=1

# Test połączenia
sudo ss -tlnp | grep :22  # Sprawdź czy SSH słucha
```

### Typowe problemy

```bash
# Problem: Usługa nie jest dostępna po dodaniu
# Rozwiązanie: Sprawdź czy daemon usługi działa
sudo systemctl status sshd

# Problem: Zmiany nie zostały zastosowane
# Rozwiązanie: Przeładuj konfigurację
sudo firewall-cmd --reload

# Problem: Błędna konfiguracja
# Rozwiązanie: Reset do domyślnych ustawień
sudo firewall-cmd --complete-reload
```

## Migracja z iptables

```bash
# Jeśli wcześniej używałeś iptables:

# 1. Zatrzymaj iptables
sudo systemctl stop iptables
sudo systemctl disable iptables

# 2. Uruchom firewalld
sudo systemctl start firewalld
sudo systemctl enable firewalld

# 3. Skonfiguruj firewalld zgodnie z potrzebami
# (firewalld używa iptables jako backend, ale zarządza nimi automatycznie)
```

Firewalld oferuje nowoczesne, elastyczne zarządzanie zaporą sieciową, które jest szczególnie przydatne w dynamicznych środowiskach sieciowych.

**Firewall w systemie Windows**
![GNOME](3_8_6_firewalld.png)

*A tak wygląda konfiguracja dla Linuksa dla strefy publicznej:*
```
[sebkoz@localhost ~]$ sudo firewall-cmd --get-active-zones public

interfaces: enp0s3  
[sebkoz@localhost ~]$ sudo sudo firewall-cmd --list-all public (active)

target: default icmp-block-inversion: no interfaces: enp0s3 sources:

services: cockpit dhcpv6-client ssh ports:  
protocols:  
forward: yes

masquerade: no forward-ports: source-ports: icmp-blocks: rich rules:
```

Dostępne gotowe scenariusze odnajdziemy przy użyciu:

```
[sebkoz@localhost ~]$ sudo firewall-cmd --get-zones  
block dmz drop external home internal nm-shared public trusted work
```

Zmiane scariusza (zone), możemy dokonać deklarując wybrany zone oraz interfejs sieciowy
```
sudo firewall-cmd --zone=home --change-interface=eth0
```
***UWAGA! Z racji że przypisujemy zone do naszego interfejsu sieciowego możemy używać różnych zone dla różnych kart. Np. łącząc się po wifi ustawimy zone public bo pracując poza domem będziemy się łączyć z publicznymi wifi natomiast w domu używając połączenia Ethernet zdefiniujemy zone na trusted albo home.***

```
[sebkoz@localhost ~]$ sudo firewall-cmd --zone=home --change-interface=enp0s3 success
```

Możemy sobie wylistować jakie zaufane serwisy (deamony) wchodzą w skład naszego zone
```
[sebkoz@localhost ~]$ sudo firewall-cmd --get-services  
RH-Satellite-6 RH-Satellite-6-capsule amanda-client amanda-k5-client amqp amqps apcupsd audit bacula bacula-client bb bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc bittorrent-lsd ceph ceph-mon cfengine cockpit collectd condor-collector ctdb dhcp dhcpv6 dhcpv6-client distcc dns dns-over-tls docker- registry docker-swarm dropbox-lansync elasticsearch etcd-client etcd-server finger foreman foreman-proxy freeipa-4 freeipa-ldap freeipa-ldaps freeipa-replication freeipa-trust ftp galera ganglia-client ganglia- master git grafana gre high-availability http https imap imaps ipp ipp-client ipsec irc ircs iscsi-target isns jenkins kadmin kdeconnect kerberos kibana klogin kpasswd kprop kshell kube-api kube-apiserver kube- control-plane kube-controller-manager kube-scheduler kubelet-worker ldap ldaps libvirt libvirt-tls lightning- network llmnr managesieve matrix mdns memcache minidlna mongodb mosh mountd mqtt mqtt-tls ms- wbt mssql murmur mysql nbd netbios-ns nfs nfs3 nmea-0183 nrpe ntp nut openvpn ovirt-imageio ovirt- storageconsole ovirt-vmconsole plex pmcd pmproxy pmwebapi pmwebapis pop3 pop3s postgresql privoxy prometheus proxy-dhcp ptp pulseaudio puppetmaster quassel radius rdp redis redis-sentinel rpc-bind rquotad rsh rsyncd rtsp salt-master samba samba-client samba-dc sane sip sips slp smtp smtp- submission smtps snmp snmptrap spideroak-lansync spotify-sync squid ssdp ssh steam-streaming svdrp svn syncthing syncthing-gui synergy syslog syslog-tls telnet tentacle tftp tile38 tinc tor-socks transmission- client upnp-client vdsm vnc-server wbem-http wbem-https wireguard wsman wsmans xdmcp xmpp-bosh xmpp-client xmpp-local xmpp-server zabbix-agent zabbix-server
```

Aby dodać jakiś serwis do naszego zone musimy dokonać utworzenia wpisu do folderu /usr/lib/firewalld/services, Plik musi zawierać nazwę serwisu i format .xml np. pakiet ssh będzie nosił nazwę ssh.xml a będzie wyglądał tak

```xml
<?xml version="1.0" encoding="utf-8"?> <service>

        <short>SSH</short>

<description>Secure Shell (SSH) is a protocol for logging into and executing commands on remote machines. It provides secure encrypted communications. If you plan on accessing your machine remotely via SSH over a firewalled interface, enable this option. You need the openssh-server package installed for this option to be useful.</description>

         <port protocol="tcp" port="22"/>
       </service>
```

Następnie należy wykonać polecenie które nam ten plik konfiguracyjny doda do naszej zone.

```
[sebkoz@localhost services]$ sudo firewall-cmd --zone=public --add-service=http
```